<!DOCTYPE html>

<html>
<head>
  <title>virgilio-http.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>virgilio-http.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Copyright (C) 2014 IceMobile Agency B.V.</p>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> restify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'restify'</span>);
module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">virgilioHttp</span><span class="hljs-params">(options)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="setup">Setup</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> virgilio = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> Promise = virgilio.Promise;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Getting options and setting defaults</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> httpOptions = options.http || {};
    <span class="hljs-keyword">var</span> port = httpOptions.port || <span class="hljs-string">'8080'</span>;
    <span class="hljs-keyword">var</span> restifyOptions = httpOptions.restify || {};
    <span class="hljs-keyword">var</span> authRoutes = httpOptions.authRoutes || {};
    <span class="hljs-keyword">var</span> httpMethods = [<span class="hljs-string">'get'</span>, <span class="hljs-string">'post'</span>, <span class="hljs-string">'put'</span>, <span class="hljs-string">'del'</span>, <span class="hljs-string">'head'</span>, <span class="hljs-string">'opts'</span>, <span class="hljs-string">'patch'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Defining the module’s actions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    virgilio = virgilio.namespace(<span class="hljs-string">'http'</span>)
        .defineAction(<span class="hljs-string">'registerRoutes'</span>, registerRoutes)
        .defineAction(<span class="hljs-string">'registerMiddleware'</span>, registerMiddleware);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Extending the base Virgilio instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    virgilio.baseVirgilio$.http = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(routeObject, basePath)</span> {</span>
        <span class="hljs-keyword">this</span>.execute(<span class="hljs-string">'http.registerRoutes'</span>, routeObject, basePath);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };
    virgilio.baseVirgilio$.httpUse = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(middleware, options)</span> {</span>
        <span class="hljs-keyword">this</span>.execute(<span class="hljs-string">'http.registerMiddleware'</span>, middleware, options);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Setup the restify server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> server = restify.createServer(restifyOptions);
    server.listen(port, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        virgilio.log.info(<span class="hljs-string">'Http server listening on port: %s'</span>, port);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="registerroutes-">registerRoutes()</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>A routeObject is an object containing subroutes and http-methods for keys.
Each subroute triggers a recursive call of registerRoutes.
Each http-method key comes with a handler object, which is registered.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerRoutes</span><span class="hljs-params">(routeObject, basePath)</span> {</span>
        basePath = sanitizePath(basePath || <span class="hljs-string">''</span>);
        <span class="hljs-keyword">var</span> routes = <span class="hljs-built_in">Object</span>.keys(routeObject);
        routes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> {</span>
            <span class="hljs-keyword">var</span> route = routeObject[key];</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Check if the key of the routeObject is an http method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (httpMethods.indexOf(key.toLowerCase()) &gt;= <span class="hljs-number">0</span>) {
                key = key.toLowerCase();
                registerRoute(basePath, key, route);
            }
            <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Recursively call registerRoutes with the extended path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> path = basePath + sanitizePath(key);
                registerRoutes(route, path);
            }
        });
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><strong>registerRoute</strong> registers a route with the restify server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerRoute</span><span class="hljs-params">(path, method, handlerObject)</span> {</span>
        <span class="hljs-keyword">var</span> handler = createHandler(handlerObject, path);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Check if this route requires authentication.
If so, create an additional authenticationHandler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> authRouteInfo = authRoutes[path];
        <span class="hljs-keyword">if</span> (authRouteInfo) {
            <span class="hljs-keyword">var</span> authHandler = createAuthHandler(authRouteInfo);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>When passed an array of handlers, restify will call them in order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            handler = [authHandler, handler];
            virgilio.log.info(<span class="hljs-string">'registering authenticated http endpoint: %s %s'</span>,
                    method.toUpperCase(), path);
        }
        <span class="hljs-keyword">else</span> {
            virgilio.log.info(<span class="hljs-string">'registering http endpoint: %s %s'</span>,
                    method.toUpperCase(), path);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Register this route with the restify server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        server[method](path, handler);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><strong>creatHandler</strong> creates a restify handler from a handlerObject.
The handler object is or contains at the very least an action,
which is executed whenever the routes receives a request.
Furthermore, a transform, respond and error function can be defined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createHandler</span><span class="hljs-params">(handlerObject, path)</span> {</span>
        handlerObject = extendHandlerObject(handlerObject, path);
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
            <span class="hljs-keyword">var</span> handlerObject = <span class="hljs-keyword">this</span>;
            Promise.cast(req)
                .then(handlerObject.transform)
                .then(handlerObject.handler)
                .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(response)</span> {</span>
                    <span class="hljs-keyword">return</span> handlerObject.respond(response, res);
                })
                .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error)</span> {</span>
                    <span class="hljs-keyword">return</span> handlerObject.error(error, res);
                })
                .catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>If the user-defined error handler fails, use the
default handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">return</span> defaultError(error, res);
                }).done();
        }.bind(handlerObject);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><strong>extendHandlerObject</strong> sets default transform, respond and error
functions on the handlerObject.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">extendHandlerObject</span><span class="hljs-params">(handlerObject, path)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Instead of passing an object with only a handler property,
the user can pass just that property (the action name, a string).
In that case, create a full-fledgec handlerObject now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> handlerObject === <span class="hljs-string">'string'</span>) {
            handlerObject = {
                handler: handlerObject,
            };
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Turn the handler property, now the action name, into a function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> handler = handlerObject.handler;
        handlerObject.handler = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args)</span> {</span>
            args = [handler].concat(args);
            <span class="hljs-keyword">return</span> virgilio.execute.apply(virgilio, args);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>EXtend the handlerObject with defaults.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        handlerObject.transform =
                handlerObject.transform || getDefaultTransform(path);
        handlerObject.respond = handlerObject.respond || defaultRespond;
        handlerObject.error = handlerObject.error || defaultError;
        handlerObject.fallbackError = defaultError;
        <span class="hljs-keyword">return</span> handlerObject;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>The default transform function will pass each parameter in order as
an argument to the action, and then add the body as a last argument.
Example:
   /someUrl/:foo/:bar -&gt; (params.foo, params.bar, body)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDefaultTransform</span><span class="hljs-params">(path)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Get all the parameter names from the path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> elements = path.split(<span class="hljs-string">'/'</span>);
        <span class="hljs-keyword">var</span> params = [];
        elements.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(element)</span> {</span>
            <span class="hljs-keyword">if</span> (element.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">':'</span>) {
                <span class="hljs-keyword">this</span>.push(element.slice(<span class="hljs-number">1</span>));
            }
        }, params);
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req)</span> {</span>
            <span class="hljs-keyword">var</span> args = params.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(param)</span> {</span>
                <span class="hljs-keyword">return</span> req.params[param];
            });
            args.push(req.body);
            <span class="hljs-keyword">return</span> args;
        };
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defaultRespond</span><span class="hljs-params">(response, res)</span> {</span>
        res.send(<span class="hljs-number">200</span>, response);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defaultError</span><span class="hljs-params">(error, res)</span> {</span>
        virgilio.log.error(error);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Only called when the user doesn’t catch the error, so it returns 500.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.send(<span class="hljs-number">500</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><strong>createAuthHandler</strong> returns a route middleware to be used by restify.
It executes auth.checkSession which another module needs to provide.
auth.checkSession needs to determine whether a user has access to a route,
based on the users sessionId and authentication info stored for the route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createAuthHandler</span><span class="hljs-params">(authRouteInfo)</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
            <span class="hljs-keyword">var</span> sessionId = req.headers[<span class="hljs-string">'session-id'</span>];
            <span class="hljs-keyword">if</span> (!sessionId) {
                <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">403</span>, <span class="hljs-string">'Not logged in.'</span>);
            }
            <span class="hljs-keyword">return</span> virgilio.execute(
                        <span class="hljs-string">'auth.checkSession'</span>, sessionId, authRouteInfo)
                .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(response)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Result has the following format:
   { result: false, reason: ‘I dont like you.’ }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (response.result) {
                        next();
                    }
                    <span class="hljs-keyword">else</span> {
                        res.send(<span class="hljs-number">403</span>, response.reason);
                    }
                })
                .catch(defaultError)
                .done();
        };
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p><strong>sanitizePath</strong> alters a path to ensure it only has a leading ‘/‘.
This way, sanitized paths can be safely concatenated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sanitizePath</span><span class="hljs-params">(path)</span> {</span>
        <span class="hljs-keyword">var</span> transformedPath = path.replace(<span class="hljs-regexp">/^\/?(.+)\/?$/</span>, <span class="hljs-string">'/$1'</span>);
        <span class="hljs-keyword">return</span> transformedPath;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="registermiddleware">registerMiddleware</h2>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Registers a middleware with the restify server.
The middleware argument is either a function or the name of
bundled restify middleware.
In the lastter case, an options argument can be provided,
to pass onl to the middleware ‘constructor’.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerMiddleware</span><span class="hljs-params">(middleware, options)</span> {</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> middleware === <span class="hljs-string">'string'</span>) {
            middleware = restify[middleware](options);
        }
        <span class="hljs-keyword">else</span> {
            middleware = middleware.bind(virgilio);
        }
        <span class="hljs-keyword">this</span>.log.trace(<span class="hljs-string">'Adding middleware.'</span>);
        server.use(middleware);
    }
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
